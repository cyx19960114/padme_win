#Contains redirects to old paths used
#Enables backwards compatibility

#Redirect to registry
server 
{
    server_name registry.padme-analytics.de www.registry.padme-analytics.de;
    listen 80;
    return 301 https://station-registry.hs-mittweida.de;
}

#
#Redirects from old domain
#

#Lets encrypt acme-challenge for menzel (cert autorenewal)
server {
        server_name menzel.informatik.rwth-aachen.de;
        listen 80 ;
        listen [::]:80 ;
        access_log /var/log/nginx/access.log vhost;
        # Do not HTTPS redirect Let'sEncrypt ACME challenge
        location ^~ /.well-known/acme-challenge/ {
                auth_basic off;
                auth_request off;
                allow all;
                root /usr/share/nginx/html;
                try_files $uri =404;
                break;
        }
        #If not the challenge: https redirect
        location / {
                return 301 https://$host$request_uri;
        }
}

#Webseite
server {
    server_name menzel.informatik.rwth-aachen.de;

    listen 443 ssl http2;
    listen [::]:443 ssl http2;
    ssl_session_timeout 5m;
    ssl_session_cache shared:SSL:50m;
    ssl_session_tickets off;
    ssl_certificate /etc/nginx/certs/menzel.informatik.rwth-aachen.de.crt;
    ssl_certificate_key /etc/nginx/certs/menzel.informatik.rwth-aachen.de.key;
    ssl_dhparam /etc/nginx/certs/menzel.informatik.rwth-aachen.de.dhparam.pem;
    ssl_stapling on;
    ssl_stapling_verify on;
    ssl_trusted_certificate /etc/nginx/certs/menzel.informatik.rwth-aachen.de.chain.pem;
    add_header Strict-Transport-Security "max-age=31536000" always;

    location / {
        return 301 https://padme-analytics.de;
    }
}

#CS
server {
    server_name menzel.informatik.rwth-aachen.de;

    listen 3005 ssl http2;
    listen [::]:3005 ssl http2;
    ssl_session_timeout 5m;
    ssl_session_cache shared:SSL:50m;
    ssl_session_tickets off;
    ssl_certificate /etc/nginx/certs/menzel.informatik.rwth-aachen.de.crt;
    ssl_certificate_key /etc/nginx/certs/menzel.informatik.rwth-aachen.de.key;
    ssl_dhparam /etc/nginx/certs/menzel.informatik.rwth-aachen.de.dhparam.pem;
    ssl_stapling on;
    ssl_stapling_verify on;
    ssl_trusted_certificate /etc/nginx/certs/menzel.informatik.rwth-aachen.de.chain.pem;
    add_header Strict-Transport-Security "max-age=31536000" always;

    location /centralservice/ {
        #Trailing slash needed (removes the /centralervice from the url)
        proxy_pass http://requester.padme-analytics.de/;
        proxy_set_header Host requester.padme-analytics.de;
    }
}

#Keykloak
server {
    server_name menzel.informatik.rwth-aachen.de;

    listen 3006 ssl http2;
    listen [::]:3006 ssl http2;
    ssl_session_timeout 5m;
    ssl_session_cache shared:SSL:50m;
    ssl_session_tickets off;
    ssl_certificate /etc/nginx/certs/menzel.informatik.rwth-aachen.de.crt;
    ssl_certificate_key /etc/nginx/certs/menzel.informatik.rwth-aachen.de.key;
    ssl_dhparam /etc/nginx/certs/menzel.informatik.rwth-aachen.de.dhparam.pem;
    ssl_stapling on;
    ssl_stapling_verify on;
    ssl_trusted_certificate /etc/nginx/certs/menzel.informatik.rwth-aachen.de.chain.pem;
    add_header Strict-Transport-Security "max-age=31536000" always;

    location /auth/realms/pht/protocol/openid-connect/token {
        #No trailing slash!!, otherwise the url is removed when passed on to the new instace
        proxy_pass http://auth.padme-analytics.de;
        #proxy_set_header Host auth.padme-analytics.de;
        proxy_redirect off;
        proxy_set_header X-Real-IP $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Host auth.padme-analytics.de;
        proxy_set_header X-Forwarded-Server auth.padme-analytics.de;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_set_header X-Forwarded-Port $server_port;
        #disable cache
        proxy_cache off;
    }

    location / {
         return 301 $scheme://auth.padme-analytics.de$request_uri;
    }
}

#Harbor
server {
    server_name menzel.informatik.rwth-aachen.de;
    listen 3007 ssl http2;
    listen [::]:3007 ssl http2;
    ssl_session_timeout 5m;
    ssl_session_cache shared:SSL:50m;
    ssl_session_tickets off;
    ssl_certificate /etc/nginx/certs/menzel.informatik.rwth-aachen.de.crt;
    ssl_certificate_key /etc/nginx/certs/menzel.informatik.rwth-aachen.de.key;
    ssl_dhparam /etc/nginx/certs/menzel.informatik.rwth-aachen.de.dhparam.pem;
    ssl_stapling on;
    ssl_stapling_verify on;
    ssl_trusted_certificate /etc/nginx/certs/menzel.informatik.rwth-aachen.de.chain.pem;
    add_header Strict-Transport-Security "max-age=31536000" always;

    client_max_body_size 0;
    chunked_transfer_encoding on;

    location / {
        proxy_pass http://repository.padme-analytics.de;
        proxy_set_header Host repository.padme-analytics.de;
        proxy_set_header  Host              $http_host;
        proxy_set_header  X-Real-IP         $remote_addr;
        proxy_set_header  X-Forwarded-For   $proxy_add_x_forwarded_for;
        proxy_set_header  X-Forwarded-Proto $scheme;

        proxy_buffering off;
        proxy_request_buffering off;
    }
}
