# Development of the Backend

## Development Setup

The backend has support for a VSCode dev container. Simply open the whole repository in VSCode, install the remote development plugin and build the dev container. You can find more info here [here](https://code.visualstudio.com/docs/remote/containers).
Moreover, execute the following to get a working development setup: 

### 1. Initialize Blazegraph with example data

1. Navigate to http://localhost:9999 and switch to the 'Update' tab
2. In the 'Type' dropdown below choose "RDF Data" and in the 'Format' dropdown choose "Turtle"
3. Paste the contents from /development/workingdata.ttl and press "Update". If you also want to have access to the ISIC use case, also upload the contents of /development/fhir.ttl
4. Now your blazegraph DB has example data to work with

### 2. Create a client in the local keycloak instance 

1. Navigate to http://localhost:8080
2. Click on 'Administration console'
3. Login with the credentials 'admin' (user) and 'admin' (pass)
4. Navigate to 'Clients' on the left side and click 'Create' in the upper right corner
5. Select import and import the the file from /development/playground.json
6. Click Save

Now keycloak should be working and you can login to the app with the credentials admin (user) and admin (pass). You can also create other users if you like. 

**Important:** please be aware that the backend does not access keycloak directly but via a port forwarding and a localhost port. You can find more details in the docker-compose-dev.yml file. The reason for this step is that if you use e.g. http://keycloak:8080 as a address we get name clashes when validating. This is because the token is generated by the frontend via the http://localhost:8080 address. So if there is ever any problem with keycloak communication, or the connection of the DEV container terminates all the time, please investigate if this is a issue with the port forwarding and nc command.

### 3. Install dependencies

Lastly, please execute npm install before running the app to install all needed dependencies.

### 4. Debugging

For starting a debugging instance, simply press f5 or the play button in VSCode. Everything should be running now.

When debugging the backend there unfortunately is **one caveat** that you should be aware of:

- When debugging and pressing the stop button, VS code always sends a SIGKILL signal. The app listens to SIGINT and SIGTERM to gracefully shutdown, which means the app will not gracefully shutdown when stopping via the vscode debug mode. However, this also means that cleanup tasks will not be performed at the end of the app runtime. Therefore: From time to time, clean the container, images, networks etc. in the playground-dind container that are kept there from the debugging sessions. Alternatively, use the 'pruneData.sh' script in the tools folder to completely get rid of the playground-dind container and create a new one (e.g., by doing a rebuild of the devcontainer compose in VSCode)